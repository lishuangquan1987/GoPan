<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoPan - ÂàÜ‰∫´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .file-item:hover {
            background-color: #f3f4f6;
        }
        .file-item.selected {
            background-color: #0078d4;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="bg-white rounded-lg shadow-xl p-6">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Êñá‰ª∂ÂàÜ‰∫´</h1>
                <div id="breadcrumb" class="text-sm text-gray-600"></div>
            </div>
            <div id="content" class="space-y-4">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="mt-4 text-gray-600">Âä†ËΩΩ‰∏≠...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="previewTitle" class="text-lg font-bold"></h3>
                <button onclick="closePreview()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="previewContent" class="flex-1 overflow-auto p-4"></div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api';
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const password = urlParams.get('password');
        let currentShare = null;
        let currentFolderId = null;
        let folderStack = [];

        async function loadShare(folderId = null) {
            try {
                const decodedPassword = password ? decodeURIComponent(password) : '';
                const url = `/shares/${code}${decodedPassword ? '?password=' + encodeURIComponent(decodedPassword) : ''}`;
                const response = await fetch(API_BASE + url);
                const data = await response.json();
                
                if (response.ok) {
                    currentShare = data;
                    if (folderId) {
                        // Load folder contents
                        await loadFolderContents(folderId);
                    } else {
                        // Display share root
                        displayShare(data);
                    }
                } else {
                    if (data.error === 'Password required' || data.error === 'Invalid password') {
                        promptPassword();
                    } else {
                        showError(data.error || 'Âä†ËΩΩÂ§±Ë¥•');
                    }
                }
            } catch (error) {
                console.error('Load share error:', error);
                showError('ÁΩëÁªúÈîôËØØ');
            }
        }

        async function loadFolderContents(folderId) {
            try {
                const decodedPassword = password ? decodeURIComponent(password) : '';
                const url = `/shares/${code}/folder/${folderId}${decodedPassword ? '?password=' + encodeURIComponent(decodedPassword) : ''}`;
                const response = await fetch(API_BASE + url);
                const data = await response.json();
                
                if (response.ok) {
                    displayFolderContents(data.files || [], folderId);
                } else {
                    showError(data.error || 'Âä†ËΩΩÊñá‰ª∂Â§πÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Load folder error:', error);
                showError('Âä†ËΩΩÊñá‰ª∂Â§πÂ§±Ë¥•');
            }
        }

        function promptPassword() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="max-w-md mx-auto">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ËØ∑ËæìÂÖ•ÂØÜÁ†Å</label>
                        <input type="password" id="sharePassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg" autofocus>
                    </div>
                    <button onclick="submitPassword()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">Á°ÆËÆ§</button>
                </div>
            `;
        }

        function submitPassword() {
            const passwordInput = document.getElementById('sharePassword');
            const pwd = passwordInput.value;
            if (!pwd) {
                alert('ËØ∑ËæìÂÖ•ÂØÜÁ†Å');
                return;
            }
            window.location.href = `/share.html?code=${code}&password=${encodeURIComponent(pwd)}`;
        }

        function displayShare(data) {
            const content = document.getElementById('content');
            const node = data.node;
            const isFile = node.type === 1;
            
            updateBreadcrumb([{ name: node.name, id: null }]);
            
            if (isFile) {
                // Display file with preview option
                content.innerHTML = `
                    <div class="text-center mb-6">
                        <div class="text-6xl mb-4">üìÑ</div>
                        <h2 class="text-xl font-bold">${escapeHtml(node.name)}</h2>
                        <p class="text-gray-600 mt-2">${formatSize(node.size)}</p>
                    </div>
                    <div class="flex gap-2 justify-center">
                        <button onclick="previewFile('${code}', ${node.id})" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            È¢ÑËßà
                        </button>
                        <button onclick="downloadFile()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            ‰∏ãËΩΩ
                        </button>
                    </div>
                    <div class="text-sm text-gray-600 text-center mt-6">
                        <p>ÂàÜ‰∫´Á†Å: ${data.code}</p>
                        ${data.expires_at ? `<p>ÊúâÊïàÊúüËá≥: ${new Date(data.expires_at).toLocaleString()}</p>` : '<p>Ê∞∏‰πÖÊúâÊïà</p>'}
                    </div>
                `;
            } else {
                // Display folder and load contents
                currentFolderId = node.id;
                folderStack = [{ name: node.name, id: node.id }];
                loadFolderContents(node.id);
            }
        }

        function displayFolderContents(files, folderId) {
            const content = document.getElementById('content');
            
            // Sort: folders first, then by name
            files.sort((a, b) => {
                if (a.type === 0 && b.type === 1) return -1;
                if (a.type === 1 && b.type === 0) return 1;
                return a.name.localeCompare(b.name);
            });
            
            if (files.length === 0) {
                content.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p class="text-lg">Êñá‰ª∂Â§π‰∏∫Á©∫</p>
                    </div>
                    <div class="mt-4">
                        <button onclick="goBack()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">ËøîÂõû</button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="mb-4">
                    <button onclick="goBack()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">‚Üê ËøîÂõû</button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            `;
            
            files.forEach(file => {
                const icon = file.type === 0 ? 'üìÅ' : 'üìÑ';
                html += `
                    <div class="file-item border border-gray-200 rounded p-4 cursor-pointer hover:bg-gray-50" 
                         onclick="${file.type === 0 ? `openFolder(${file.id}, '${escapeHtml(file.name)}')` : `previewFile('${code}', ${file.id})`}">
                        <div class="text-center">
                            <div class="text-4xl mb-2">${icon}</div>
                            <div class="text-sm font-medium truncate" title="${escapeHtml(file.name)}">${escapeHtml(file.name)}</div>
                            ${file.type === 1 ? `<div class="text-xs text-gray-500 mt-1">${formatSize(file.size)}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        function openFolder(folderId, folderName) {
            folderStack.push({ name: folderName, id: folderId });
            currentFolderId = folderId;
            updateBreadcrumb(folderStack);
            loadFolderContents(folderId);
        }

        function goBack() {
            if (folderStack.length > 1) {
                folderStack.pop();
                const prevFolder = folderStack[folderStack.length - 1];
                currentFolderId = prevFolder.id;
                updateBreadcrumb(folderStack);
                if (prevFolder.id) {
                    loadFolderContents(prevFolder.id);
                } else {
                    // Back to root
                    displayShare(currentShare);
                }
            } else if (folderStack.length === 1) {
                // Back to root share
                folderStack = [];
                currentFolderId = null;
                displayShare(currentShare);
            }
        }

        function updateBreadcrumb(stack) {
            const breadcrumb = document.getElementById('breadcrumb');
            if (!stack || stack.length === 0) {
                breadcrumb.innerHTML = '';
                return;
            }
            let html = '';
            stack.forEach((item, index) => {
                if (index > 0) html += ' / ';
                html += `<span class="${index === stack.length - 1 ? 'font-semibold' : ''}">${escapeHtml(item.name)}</span>`;
            });
            breadcrumb.innerHTML = html;
        }

        async function previewFile(shareCode, fileId) {
            try {
                const decodedPassword = password ? decodeURIComponent(password) : '';
                const url = `/shares/${shareCode}/preview/${fileId}${decodedPassword ? '?password=' + encodeURIComponent(decodedPassword) : ''}`;
                const response = await fetch(API_BASE + url);
                const data = await response.json();
                
                if (response.ok) {
                    showPreview(data);
                } else {
                    alert(data.error || 'È¢ÑËßàÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Preview error:', error);
                alert('È¢ÑËßàÂ§±Ë¥•');
            }
        }

        function showPreview(data) {
            const modal = document.getElementById('previewModal');
            const title = document.getElementById('previewTitle');
            const content = document.getElementById('previewContent');
            
            title.textContent = data.file_name || 'È¢ÑËßà';
            modal.classList.remove('hidden');
            
            if (data.type === 'text') {
                content.innerHTML = `
                    <textarea class="w-full h-full p-4 border border-gray-300 rounded font-mono text-sm" readonly>${escapeHtml(data.content)}</textarea>
                `;
            } else if (data.type === 'office' || data.type === 'pdf' || data.type === 'kkfileview') {
                content.innerHTML = `
                    <iframe src="${data.url}" class="w-full h-full border-0" style="min-height: 600px;"></iframe>
                `;
            } else if (data.type === 'url') {
                // For images and other direct URLs
                if (data.mime_type && data.mime_type.startsWith('image/')) {
                    content.innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <img src="${data.url}" alt="${escapeHtml(data.file_name)}" class="max-w-full max-h-full">
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="text-center py-8">
                            <p class="mb-4">Êó†Ê≥ïÈ¢ÑËßàÊ≠§Êñá‰ª∂Á±ªÂûã</p>
                            <a href="${data.url}" target="_blank" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">‰∏ãËΩΩÊñá‰ª∂</a>
                        </div>
                    `;
                }
            }
        }

        function closePreview() {
            document.getElementById('previewModal').classList.add('hidden');
        }

        function downloadFile() {
            const decodedPassword = password ? decodeURIComponent(password) : '';
            const url = `/shares/${code}/download${decodedPassword ? '?password=' + encodeURIComponent(decodedPassword) : ''}`;
            window.open(API_BASE + url, '_blank');
        }

        function formatSize(bytes) {
            if (!bytes) return '0 B';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(msg) {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="text-center text-red-600 py-8">
                    <p class="text-xl mb-4">‚ùå</p>
                    <p>${escapeHtml(msg)}</p>
                </div>
            `;
        }

        // Close preview on outside click
        document.getElementById('previewModal').addEventListener('click', (e) => {
            if (e.target.id === 'previewModal') {
                closePreview();
            }
        });

        if (code) {
            loadShare();
        } else {
            showError('Êó†ÊïàÁöÑÂàÜ‰∫´ÈìæÊé•');
        }
    </script>
</body>
</html>
