---
name: GoPan网盘系统开发
overview: 构建一个完整的网盘系统，包括用户认证、文件管理、分享功能、文件快传、在线预览编辑等核心功能，最终编译成单个exe文件运行。
todos:
  - id: schema
    content: 扩展数据库Schema：完善User和Node，新增Share和FileHash schema
    status: completed
  - id: deps
    content: 添加项目依赖：Gin、MinIO客户端、JWT、PostgreSQL驱动、bcrypt等
    status: completed
  - id: config
    content: 创建配置管理模块，支持数据库、MinIO、JWT等配置
    status: completed
  - id: database
    content: 实现数据库连接和MinIO客户端初始化
    status: completed
  - id: auth
    content: 实现JWT认证模块和认证中间件
    status: completed
  - id: api-auth
    content: 实现用户认证API（注册、登录、登出）
    status: completed
  - id: api-file
    content: 实现文件管理API（上传、下载、删除、创建文件夹等）
    status: completed
  - id: quick-upload
    content: 实现文件快传功能（基于文件hash）
    status: completed
  - id: api-share
    content: 实现分享功能API（创建分享、获取分享、下载分享）
    status: completed
  - id: preview
    content: 实现文件预览服务（文本、图片、PDF、Office、代码、视频）
    status: completed
  - id: frontend
    content: 开发前端页面和交互逻辑（HTML+TailwindCSS+JavaScript）
    status: completed
  - id: embed
    content: 使用embed将前端资源嵌入到Go二进制文件
    status: completed
  - id: main
    content: 完善main.go，整合所有模块，实现优雅启动和关闭
    status: completed
---

# GoPan网盘系统开发计划

## 项目概述

构建一个功能完整的网盘系统，后端使用Go+Gin+Ent+MinIO+PostgreSQL，前端使用HTML+TailwindCSS，最终编译成单个exe文件。

## 技术栈

- **后端**: Go 1.24.2, Gin, Ent ORM, MinIO客户端, PostgreSQL, JWT
- **前端**: HTML5, TailwindCSS, JavaScript (原生)
- **打包**: embed包嵌入前端资源到二进制文件

## 实施步骤

### 1. 数据库Schema扩展

**文件**: `src/ent/schema/`

- **扩展User schema** (`user.go`): 添加邮箱、创建时间、最后登录时间等字段
- **扩展Node schema** (`node.go`): 添加用户关联、文件大小、MIME类型、文件hash、创建时间、更新时间等字段，建立父子关系
- **创建Share schema** (`share.go`): 分享功能，包含分享码、分享类型（永久/时效）、过期时间、访问次数等
- **创建FileHash schema** (`filehash.go`): 文件快传功能，存储文件hash和MinIO对象名映射

### 2. 项目依赖和配置

**文件**: `src/go.mod`, `src/config/config.go`

- 添加依赖: `github.com/gin-gonic/gin`, `github.com/minio/minio-go/v7`, `github.com/golang-jwt/jwt/v5`, `github.com/lib/pq`, `golang.org/x/crypto`等
- 创建配置管理模块，支持环境变量和配置文件
- 配置数据库连接、MinIO连接、JWT密钥等

### 3. 数据库和MinIO初始化

**文件**: `src/internal/database/db.go`, `src/internal/storage/minio.go`

- 实现PostgreSQL数据库连接和迁移
- 实现MinIO客户端初始化和bucket创建
- 实现Ent客户端初始化

### 4. 认证模块

**文件**: `src/internal/auth/jwt.go`, `src/internal/middleware/auth.go`

- 实现JWT token生成和验证
- 实现认证中间件
- 实现密码加密（使用bcrypt替代MD5）

### 5. API路由和控制器

**文件**: `src/internal/api/`

#### 5.1 用户认证API (`auth.go`)

- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/logout` - 用户登出
- `GET /api/auth/me` - 获取当前用户信息

#### 5.2 文件管理API (`file.go`)

- `GET /api/files` - 获取文件列表（支持分页、路径查询、排序、筛选）
- `POST /api/files/upload` - 上传文件（支持分片上传、拖拽上传）
- `POST /api/files/folder` - 创建文件夹
- `GET /api/files/tree` - 获取文件夹树形结构（用于侧边栏导航）
- `GET /api/files/:id` - 获取文件信息
- `GET /api/files/:id/download` - 下载文件
- `PUT /api/files/:id` - 重命名文件
- `PUT /api/files/move` - 移动文件/文件夹（批量）
- `PUT /api/files/copy` - 复制文件/文件夹（批量）
- `DELETE /api/files/:id` - 删除文件（移动到回收站）
- `DELETE /api/files` - 批量删除文件
- `POST /api/files/quick-upload` - 文件快传（基于hash）
- `GET /api/files/search` - 搜索文件（按文件名、类型等）
- `GET /api/files/trash` - 获取回收站文件列表
- `POST /api/files/restore` - 恢复回收站文件
- `DELETE /api/files/trash/:id` - 永久删除文件
- `DELETE /api/files/trash` - 清空回收站

#### 5.3 分享功能API (`share.go`)

- `POST /api/shares` - 创建分享
- `GET /api/shares/:code` - 获取分享信息
- `GET /api/shares/:code/download` - 通过分享码下载
- `DELETE /api/shares/:id` - 删除分享
- `GET /api/shares` - 获取我的分享列表

### 6. 文件预览和编辑服务

**文件**: `src/internal/preview/`

- **文本预览** (`text.go`): 支持.txt, .md, .json等文本文件
- **图片预览** (`image.go`): 支持常见图片格式，提供缩略图
- **PDF预览** (`pdf.go`): 使用PDF.js或后端转换
- **Office预览** (`office.go`): 使用在线转换服务或后端库
- **代码预览** (`code.go`): 语法高亮显示
- **视频预览** (`video.go`): 视频播放器支持

**API端点**:

- `GET /api/preview/:id` - 获取预览URL或内容
- `PUT /api/files/:id/content` - 编辑文本文件内容

### 7. 前端页面开发（Windows资源管理器风格，参考百度网盘）

**文件**: `src/web/`

#### 7.1 页面结构

- `index.html` - 主页面（登录/注册，简洁现代的设计）
- `dashboard.html` - 网盘主界面（单页应用，完全模拟Windows资源管理器体验）
- `preview.html` - 文件预览页面（支持全屏预览）
- `share.html` - 分享页面（简洁的分享链接展示和下载）

#### 7.2 静态资源

- `static/css/` - TailwindCSS样式（使用CDN，确保离线可用时使用本地文件）
- `static/js/` - JavaScript模块
  - `api.js` - API调用封装（统一错误处理、请求拦截）
  - `auth.js` - 认证相关（登录、注册、登出、token管理）
  - `file.js` - 文件管理核心逻辑（文件CRUD操作）
  - `fileManager.js` - 文件管理器主控制器（类似Windows资源管理器，管理状态、历史记录）
  - `upload.js` - 文件上传（支持拖拽、进度条、多文件、断点续传）
  - `preview.js` - 文件预览（文本、图片、PDF、Office、代码、视频）
  - `share.js` - 分享功能（创建分享、复制链接、管理分享）
  - `contextMenu.js` - 右键菜单（完全模拟Windows右键菜单样式和交互）
  - `keyboard.js` - 快捷键支持（完整的Windows快捷键映射）
  - `clipboard.js` - 剪贴板操作（复制、剪切、粘贴，支持跨文件夹操作）
  - `fileIcons.js` - 文件图标和类型识别（根据扩展名和MIME类型显示图标）
  - `treeView.js` - 侧边栏文件夹树（可折叠、拖拽、右键菜单）
  - `breadcrumb.js` - 面包屑导航（可点击跳转，显示完整路径）
  - `toolbar.js` - 工具栏控制（视图切换、排序、筛选）
  - `selection.js` - 多选管理（单选、多选、框选、全选）
  - `history.js` - 浏览历史（前进、后退功能）
  - `search.js` - 文件搜索（实时搜索、高亮显示）
  - `dialog.js` - 对话框组件（确认、提示、输入对话框）
  - `toast.js` - 消息提示（成功、错误、警告提示）

#### 7.3 UI组件（完全Windows资源管理器风格）

**主界面布局**（参考Windows 10/11资源管理器）:

- **顶部标题栏**: 显示当前文件夹名称，最小化/最大化/关闭按钮（如果作为独立窗口）
- **顶部工具栏**: 
  - 后退/前进按钮（带下拉菜单显示历史）
  - 向上按钮（返回上一级）
  - 路径输入框（可编辑，支持直接输入路径跳转）
  - 搜索框（实时搜索，带筛选选项）
  - 视图切换按钮组（大图标、列表、详细信息、网格）
  - 操作按钮组（上传、新建文件夹、分享、删除）
- **左侧边栏**: 
  - 快速访问区域（我的文件、最近使用、收藏）
  - 文件夹树形导航（可折叠展开，支持拖拽）
  - 系统区域（回收站、我的分享、设置）
- **中间主区域**: 
  - 文件列表视图（根据选择的视图模式显示）
  - 空文件夹提示（友好的提示信息）
  - 加载状态（骨架屏或加载动画）
- **底部状态栏**: 
  - 选中文件数量和信息
  - 当前文件夹统计信息（文件数、总大小）
  - 当前路径显示

**文件列表功能**（完全模拟Windows体验）:

- **视图模式**（参考Windows资源管理器）: 
  - **超大图标视图**: 显示大图标和文件名，适合图片预览
  - **大图标视图**: 中等大小图标，文件名在下方
  - **中等图标视图**: 较小图标，文件名在下方
  - **小图标视图**: 小图标，文件名在右侧
  - **列表视图**: 小图标列表，显示名称、大小、修改时间
  - **详细信息视图**: 表格形式，显示名称、大小、类型、修改时间、创建时间（可调整列宽、点击表头排序、可显示/隐藏列）
  - **平铺视图**: 中等图标，右侧显示详细信息
- **文件图标系统**: 
  - 文件夹图标（打开/关闭状态）
  - 文件类型图标（图片、文档、视频、音频、代码、压缩包、可执行文件等）
  - 文件状态图标（分享中、锁定、同步中等）
  - 使用SVG图标或图标字体，确保清晰
- **多选操作**（完全模拟Windows选择行为）: 
  - 单击选择单个文件（取消其他选择）
  - Ctrl+点击多选（切换选择状态）
  - Shift+点击范围选择（选择连续文件）
  - Ctrl+A全选
  - 拖拽框选（鼠标拖拽选择多个文件）
  - 选择状态视觉反馈（高亮、复选框）
- **排序功能**: 
  - 点击表头排序（名称、大小、类型、修改时间、创建时间）
  - 支持升序/降序切换（点击表头切换）
  - 排序指示器（箭头显示当前排序方向和列）
  - 文件夹优先排序（文件夹始终在文件前面）
- **筛选功能**: 
  - 按文件类型筛选（全部、图片、文档、视频、音频、压缩包、代码等）
  - 按日期筛选（今天、本周、本月、自定义范围）
  - 按大小筛选（小文件、中等文件、大文件）
  - 筛选条件组合
- **文件重命名**: 
  - 单击文件名进入编辑模式（类似Windows）
  - 自动选中文件名（不含扩展名）
  - Enter确认，Esc取消
  - 文件名验证（不能包含特殊字符、不能重名）

**右键菜单**（完全模拟Windows右键菜单样式和功能）:

- **主要操作**:
  - 打开/预览（根据文件类型）
  - 下载
  - 分享（创建分享链接）
- **编辑操作**:
  - 重命名（F2）
  - 复制（Ctrl+C）
  - 剪切（Ctrl+X）
  - 粘贴（Ctrl+V，在空白处右键时显示）
  - 删除（Delete键，移动到回收站）
  - 永久删除（Shift+Delete）
- **高级操作**:
  - 属性（显示文件详细信息对话框）
  - 创建快捷方式（可选功能）
  - 压缩（如果支持）
  - 解压（如果是压缩包）
- **菜单样式**: 
  - 分组显示（分隔线分组）
  - 图标显示（每个菜单项带图标）
  - 快捷键提示（显示对应的快捷键）
  - 子菜单支持（某些操作有子菜单）
  - 禁用状态（某些操作在特定情况下禁用）

**快捷键支持**（完整的Windows快捷键映射）:

- **文件操作**:
  - `Ctrl+C` - 复制选中文件
  - `Ctrl+X` - 剪切选中文件
  - `Ctrl+V` - 粘贴文件
  - `Ctrl+A` - 全选
  - `Delete` - 删除到回收站
  - `Shift+Delete` - 永久删除
  - `F2` - 重命名选中文件
  - `F5` - 刷新当前文件夹
  - `Ctrl+N` - 新建文件夹
  - `Ctrl+U` - 上传文件对话框
  - `Ctrl+F` - 聚焦搜索框
  - `Ctrl+Z` - 撤销（如果支持）
- **导航操作**:
  - `Backspace` - 返回上一级
  - `Alt+Left` - 后退
  - `Alt+Right` - 前进
  - `Alt+Up` - 向上
  - `Enter` - 打开文件/文件夹
  - `Ctrl+Enter` - 在新标签页打开（如果支持多标签）
- **视图操作**:
  - `Ctrl+Plus` - 放大图标
  - `Ctrl+Minus` - 缩小图标
  - `Ctrl+0` - 重置视图大小
  - `Ctrl+1-6` - 切换不同视图模式

**拖拽功能**（完全模拟Windows拖拽体验）:

- **从系统拖拽上传**:
  - 从Windows文件管理器拖拽文件到浏览器
  - 拖拽到上传区域或文件列表区域
  - 拖拽时显示视觉反馈（高亮区域）
  - 支持多文件拖拽
- **网盘内拖拽移动**:
  - 拖拽文件/文件夹到目标文件夹
  - 拖拽到文件夹树进行移动
  - 拖拽时显示目标位置提示
  - 支持Ctrl+拖拽复制（显示复制图标）
  - 拖拽到无效位置时显示禁止图标
- **拖拽反馈**:
  - 拖拽时显示半透明预览
  - 目标位置高亮显示
  - 显示操作类型（移动/复制）

**文件属性对话框**（类似Windows属性对话框）:

- **常规标签**:
  - 文件图标和名称
  - 文件类型和大小
  - 位置（完整路径）
  - 创建时间、修改时间、访问时间
- **分享标签**（如果有分享）:
  - 分享链接列表
  - 分享设置（永久/时效、密码等）
  - 访问统计
- **其他信息**:
  - 文件hash（用于快传）
  - MIME类型
  - 所有者信息

**其他Windows风格特性和百度网盘功能**:

- **面包屑导航**: 
  - 显示完整路径
  - 每个路径段可点击跳转
  - 路径过长时自动省略中间部分
  - 点击路径输入框可编辑路径
- **浏览历史**: 
  - 前进/后退按钮（带下拉菜单显示历史）
  - 历史记录管理（最多保存50条）
  - 支持浏览器前进/后退快捷键
- **回收站功能**: 
  - 删除的文件移动到回收站
  - 回收站中可恢复或永久删除
  - 回收站自动清理（30天后自动删除）
  - 回收站容量显示
- **文件搜索**: 
  - 实时搜索（输入即搜索）
  - 支持文件名模糊匹配
  - 支持文件类型筛选
  - 搜索结果高亮显示
  - 搜索历史记录
- **上传功能**（参考百度网盘）:
  - 拖拽上传区域（整个文件列表区域）
  - 上传进度显示（每个文件独立进度条）
  - 上传速度显示
  - 上传队列管理（暂停、取消、重试）
  - 断点续传支持（大文件）
  - 上传完成提示
  - 快传提示（如果文件已存在，显示秒传成功）
- **下载功能**:
  - 下载进度显示
  - 下载速度显示
  - 下载队列管理
  - 下载完成提示
- **分享功能**（参考百度网盘）:
  - 一键创建分享链接
  - 分享设置（永久/时效、密码、访问次数限制）
  - 分享链接复制
  - 分享二维码生成
  - 分享管理（查看、编辑、取消分享）
- **文件预览**（参考百度网盘）:
  - 图片预览（支持缩放、旋转、全屏）
  - 文本预览（支持编辑、语法高亮）
  - PDF预览（使用PDF.js）
  - Office文档预览（在线转换或使用Office Online）
  - 视频播放（支持常见视频格式）
  - 音频播放（支持常见音频格式）
  - 代码预览（语法高亮、行号）
- **用户体验优化**:
  - 加载动画（骨架屏、加载指示器）
  - 操作确认对话框（删除、覆盖、永久删除等）
  - 消息提示（成功、错误、警告，自动消失）
  - 错误处理（友好的错误提示）
  - 空状态提示（空文件夹、无搜索结果等）
  - 响应式设计（适配不同屏幕尺寸）
  - 暗色模式支持（可选）
  - 操作反馈（按钮点击反馈、拖拽反馈等）

### 8. 静态资源嵌入（使用Go embed技术）

**文件**: `src/main.go`

- 使用Go 1.16+的`embed`包将`web/`目录下的所有前端资源（HTML、CSS、JS、图片等）嵌入到二进制文件
- 使用`//go:embed web`指令嵌入整个web目录
- 实现静态文件服务中间件，从嵌入的FS中提供静态文件
- 配置路由策略：
  - `/api/*` - API请求，返回JSON
  - `/*` - 其他请求，返回前端页面（SPA路由支持）
- 确保所有前端资源都打包进exe，无需外部文件依赖

### 9. 主程序入口

**文件**: `src/main.go`

- 初始化配置
- 初始化数据库连接和迁移
- 初始化MinIO连接
- 设置Gin路由
- 启动HTTP服务器
- 支持优雅关闭

### 10. 构建配置

**文件**: `build.sh` 或 `Makefile`

- 编译命令，生成单个exe文件
- 可选：添加版本信息和构建时间

## 关键技术点

1. **文件快传**: 上传前计算文件hash（MD5/SHA256），查询数据库，如果存在则直接创建文件记录，无需实际上传
2. **分享功能**: 生成唯一分享码，支持永久分享和时效分享（带过期时间）
3. **前端嵌入**: 使用Go 1.16+的embed功能，将前端资源编译进二进制文件
4. **文件预览**: 文本和代码直接返回，图片和PDF提供预览URL，Office文档可能需要转换
5. **权限控制**: 所有文件操作都需要JWT认证，确保用户只能访问自己的文件

## 目录结构

```
src/
├── main.go                 # 主程序入口
├── generate.go             # Ent代码生成脚本（与main.go同目录，方便执行）
├── config/                 # 配置管理
├── internal/
│   ├── api/               # API路由和控制器
│   ├── auth/              # 认证相关
│   ├── database/          # 数据库连接
│   ├── storage/           # MinIO存储
│   ├── middleware/        # 中间件
│   └── preview/           # 预览服务
├── ent/                   # Ent ORM
│   └── schema/            # 数据模型
└── web/                   # 前端资源（将被嵌入）
    ├── index.html
    ├── dashboard.html
    └── static/
```

## 注意事项

1. 密码存储使用bcrypt，不使用MD5
2. 文件上传支持大文件分片上传
3. 分享链接需要生成唯一且不易猜测的分享码
4. 前端使用TailwindCSS CDN或本地文件，确保离线可用
5. 所有API返回统一的JSON格式
6. 错误处理要完善，返回有意义的错误信息